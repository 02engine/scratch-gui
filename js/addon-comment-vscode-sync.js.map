{"version":3,"file":"js/addon-comment-vscode-sync.js","sources":["webpack://GUI/./src/addons/addons/comment-vscode-sync/userstyle.css","webpack://GUI/./src/addons/addons/comment-vscode-sync/icons/vscode.svg","webpack://GUI/./src/addons/addons/comment-vscode-sync/_runtime_entry.js","webpack://GUI/./src/addons/addons/comment-vscode-sync/userscript.js"],"sourcesContent":["exports = module.exports = require(\"../../../../node_modules/css-loader/lib/css-base.js\")(false);\n// imports\n\n\n// module\nexports.push([module.id, \"/* Comment VSCode Sync Button Styles */\\n\\n.sa-comment-vscode-btn {\\n  position: absolute;\\n  right: 2px;\\n  top: 2px;\\n  width: 16px;\\n  height: 16px;\\n  padding: 0;\\n  margin: 0;\\n  border: none;\\n  background: transparent;\\n  cursor: pointer;\\n  display: flex;\\n  align-items: center;\\n  justify-content: center;\\n  opacity: 0.7;\\n  transition: opacity 0.2s, filter 0.2s;\\n  z-index: 100;\\n}\\n\\n.sa-comment-vscode-btn:hover {\\n  opacity: 1;\\n  filter: brightness(1.2);\\n}\\n\\n.sa-comment-vscode-btn.sa-comment-vscode-disabled {\\n  opacity: 0.3;\\n  cursor: not-allowed;\\n  filter: grayscale(100%);\\n}\\n\\n.sa-comment-vscode-btn.sa-comment-vscode-synced {\\n  opacity: 1;\\n}\\n\\n.sa-comment-vscode-btn.sa-comment-vscode-synced::after {\\n  content: '';\\n  position: absolute;\\n  bottom: -2px;\\n  right: -2px;\\n  width: 6px;\\n  height: 6px;\\n  background-color: #4caf50;\\n  border-radius: 50%;\\n  border: 1px solid var(--ui-modal-background, #fff);\\n}\\n\\n.sa-comment-vscode-icon {\\n  width: 14px;\\n  height: 14px;\\n  pointer-events: none;\\n}\\n\\n/* 确保按钮在注释顶部栏正确显示 */\\n.scratchCommentBody,\\n[class*=\\\"scratchCommentBody\\\"],\\n[class*=\\\"TopBar\\\"] {\\n  position: relative;\\n}\\n\\n/* 暗色模式适配 */\\n[data-theme=\\\"dark\\\"] .sa-comment-vscode-btn,\\n.dark .sa-comment-vscode-btn {\\n  opacity: 0.8;\\n}\\n\\n[data-theme=\\\"dark\\\"] .sa-comment-vscode-btn:hover,\\n.dark .sa-comment-vscode-btn:hover {\\n  opacity: 1;\\n}\\n\\n[data-theme=\\\"dark\\\"] .sa-comment-vscode-btn.sa-comment-vscode-disabled,\\n.dark .sa-comment-vscode-btn.sa-comment-vscode-disabled {\\n  opacity: 0.2;\\n}\\n\", \"\"]);\n\n// exports\n","export default \"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj4KICA8cG9seWxpbmUgcG9pbnRzPSIxNiAxOCAyMiAxMiAxNiA2Ij48L3BvbHlsaW5lPgogIDxwb2x5bGluZSBwb2ludHM9IjggNiAyIDEyIDggMTgiPjwvcG9seWxpbmU+Cjwvc3ZnPg==\"","import _js from \"./userscript.js\";\nimport _css from \"!css-loader!./userstyle.css\";\nimport _vscodeIcon from \"!url-loader!./icons/vscode.svg\";\n\nexport const resources = {\n  \"userscript.js\": _js,\n  \"userstyle.css\": _css,\n  \"icons/vscode.svg\": _vscodeIcon\n};\n","export default async function ({ addon, console, msg }) {\n  const vm = addon.tab.traps.vm;\n  \n  // 等待 Blockly 加载\n  const Blockly = await addon.tab.traps.getBlockly();\n  \n  // WebSocket 连接状态\n  let isConnected = false;\n  \n  // 跟踪已处理的注释\n  const processedComments = new Map();\n  \n  // 获取 VSCode 图标 URL\n  const vscodeIconUrl = addon.self.getResource('/icons/vscode.svg');\n  \n  /**\n   * 检查 WebSocket 连接状态\n   */\n  function checkConnection() {\n    if (typeof window !== 'undefined' && window.ScratchExtensionDebug) {\n      isConnected = window.ScratchExtensionDebug.isConnected();\n    }\n    return isConnected;\n  }\n  \n  /**\n   * 发送消息到 WebSocket 服务器\n   */\n  function sendMessage(message) {\n    if (typeof window !== 'undefined' && window.ScratchExtensionDebug) {\n      // 使用全局的 sendMessage 函数\n      const ws = window.ScratchExtensionDebug.ws;\n      if (ws && ws.readyState === WebSocket.OPEN) {\n        ws.send(JSON.stringify(message));\n        return true;\n      }\n    }\n    return false;\n  }\n  \n  /**\n   * 获取注释 ID\n   * 从 DOM 或 Blockly 对象中提取唯一标识\n   * 使用 data 属性缓存 ID，确保同一注释始终使用相同 ID\n   */\n  function getCommentId(commentEl) {\n    // 如果已经有缓存的 ID，直接返回\n    if (commentEl.dataset.commentId) {\n      return commentEl.dataset.commentId;\n    }\n    \n    // 尝试从 Blockly 工作区获取\n    const workspace = Blockly.getMainWorkspace();\n    if (workspace) {\n      const topComments = workspace.getTopComments();\n      for (const comment of topComments) {\n        // 通过位置匹配查找注释\n        const commentSvg = comment.getSvgRoot();\n        if (commentSvg === commentEl || commentSvg.contains(commentEl)) {\n          // 缓存 ID 到 DOM 元素\n          commentEl.dataset.commentId = comment.id;\n          return comment.id;\n        }\n      }\n    }\n    \n    // 生成临时 ID 并缓存到 DOM 元素\n    const tempId = 'comment_' + Math.random().toString(36).substr(2, 9);\n    commentEl.dataset.commentId = tempId;\n    return tempId;\n  }\n  \n  /**\n   * 获取注释内容\n   */\n  function getCommentContent(commentEl) {\n    const textarea = commentEl.querySelector('textarea');\n    return textarea ? textarea.value : '';\n  }\n  \n  /**\n   * 设置注释内容\n   * 同时更新 VM 数据和 DOM，并标记项目已更改\n   */\n  function setCommentContent(commentEl, content) {\n    const textarea = commentEl.querySelector('textarea');\n    if (!textarea) return;\n    \n    // 保存焦点状态\n    const wasFocused = document.activeElement === textarea;\n    \n    // 1. 更新 DOM\n    textarea.value = content;\n    \n    // 2. 触发 input 事件以更新其他监听器\n    const inputEvent = new Event('input', { bubbles: true });\n    textarea.dispatchEvent(inputEvent);\n    \n    // 3. 更新 VM 中的注释数据（关键！）\n    const commentId = getCommentId(commentEl);\n    const target = vm.editingTarget;\n    if (target && target.comments && target.comments[commentId]) {\n      target.comments[commentId].text = content;\n      \n      // 4. 标记项目已更改（关键！）\n      if (vm.runtime && vm.runtime.emitProjectChanged) {\n        vm.runtime.emitProjectChanged();\n      }\n    }\n    \n    // 5. 如果之前有焦点，恢复焦点\n    if (wasFocused) {\n      textarea.focus();\n    }\n  }\n  \n  /**\n   * 获取当前编辑目标（角色）信息\n   */\n  function getCurrentTarget() {\n    const editingTarget = vm.editingTarget;\n    return {\n      id: editingTarget ? editingTarget.id : null,\n      name: editingTarget ? editingTarget.getName() : 'unknown'\n    };\n  }\n  \n  /**\n   * 处理 VSCode 按钮点击\n   */\n  function handleVSCodeButtonClick(commentEl, buttonEl) {\n    if (!checkConnection()) {\n      console.warn('[CommentVSCodeSync] Not connected to server');\n      alert(msg('not-connected'));\n      return;\n    }\n    \n    const commentId = getCommentId(commentEl);\n    const content = getCommentContent(commentEl);\n    const target = getCurrentTarget();\n    \n    // 发送打开注释消息\n    const message = {\n      type: 'comment',\n      action: 'open',\n      commentId: commentId,\n      content: content,\n      targetId: target.id,\n      targetName: target.name,\n      timestamp: Date.now()\n    };\n    \n    if (sendMessage(message)) {\n      // 标记为已同步\n      commentEl.dataset.vscodeSynced = 'true';\n      buttonEl.classList.add('sa-comment-vscode-synced');\n      buttonEl.title = msg('synced-tooltip');\n      console.log('[CommentVSCodeSync] Sent open message for comment:', commentId);\n    } else {\n      console.error('[CommentVSCodeSync] Failed to send message');\n      alert(msg('send-failed'));\n    }\n  }\n  \n  /**\n   * 创建 VSCode 同步按钮\n   */\n  function createVSCodeButton(commentEl) {\n    // 检查是否已存在\n    if (commentEl.querySelector('.sa-comment-vscode-btn')) {\n      return null;\n    }\n    \n    // 查找顶部栏\n    const topBar = commentEl.querySelector('.scratchCommentBody') || \n                   commentEl.querySelector('[class*=\"TopBar\"]') ||\n                   commentEl.firstElementChild;\n    \n    if (!topBar) {\n      return null;\n    }\n    \n    // 创建按钮\n    const button = document.createElement('button');\n    button.className = 'sa-comment-vscode-btn';\n    button.title = msg('sync-tooltip');\n    button.type = 'button';\n    \n    // 创建图标\n    const icon = document.createElement('img');\n    icon.src = vscodeIconUrl;\n    icon.alt = 'VSCode';\n    icon.className = 'sa-comment-vscode-icon';\n    button.appendChild(icon);\n    \n    // 添加点击事件\n    button.addEventListener('click', (e) => {\n      e.stopPropagation();\n      e.preventDefault();\n      handleVSCodeButtonClick(commentEl, button);\n    });\n    \n    // 找到关闭按钮并插入到其前面\n    const closeButton = topBar.querySelector('[class*=\"close\"], [class*=\"delete\"]');\n    if (closeButton) {\n      topBar.insertBefore(button, closeButton);\n    } else {\n      topBar.appendChild(button);\n    }\n    \n    // 检查连接状态并更新按钮\n    checkConnection();\n    if (!isConnected) {\n      button.classList.add('sa-comment-vscode-disabled');\n      button.title = msg('not-connected');\n    }\n    \n    return button;\n  }\n  \n  /**\n   * 处理所有注释元素\n   */\n  function processCommentElements() {\n    if (addon.self.disabled) return;\n    \n    const commentElements = document.querySelectorAll('.blocklyBubbleCanvas > g');\n    \n    commentElements.forEach(commentEl => {\n      // 检查是否已经处理过\n      if (processedComments.has(commentEl)) {\n        return;\n      }\n      \n      // 检查是否是注释（有 textarea）\n      const textarea = commentEl.querySelector('textarea');\n      if (!textarea) {\n        return;\n      }\n      \n      // 创建按钮\n      const button = createVSCodeButton(commentEl);\n      if (button) {\n        processedComments.set(commentEl, {\n          button: button,\n          commentId: getCommentId(commentEl)\n        });\n      }\n    });\n  }\n  \n  /**\n   * 处理从 VSCode 返回的更新消息\n   */\n  function handleCommentUpdate(event) {\n    const detail = event.detail;\n    if (!detail || detail.type !== 'comment' || detail.action !== 'update') {\n      return;\n    }\n    \n    const { commentId, content } = detail;\n    \n    // 查找对应的注释元素\n    for (const [commentEl, data] of processedComments.entries()) {\n      if (data.commentId === commentId) {\n        // 更新注释内容\n        setCommentContent(commentEl, content);\n        console.log('[CommentVSCodeSync] Updated comment content from VSCode:', commentId);\n        break;\n      }\n    }\n  }\n  \n  /**\n   * 清理已移除的注释\n   */\n  function cleanupRemovedComments() {\n    const commentElements = document.querySelectorAll('.blocklyBubbleCanvas > g');\n    const currentElements = new Set(commentElements);\n    \n    for (const [commentEl] of processedComments) {\n      if (!currentElements.has(commentEl) || !document.contains(commentEl)) {\n        processedComments.delete(commentEl);\n      }\n    }\n  }\n  \n  /**\n   * 更新所有按钮的连接状态\n   */\n  function updateButtonStates() {\n    checkConnection();\n    \n    for (const [commentEl, data] of processedComments) {\n      const button = data.button;\n      if (!button) continue;\n      \n      if (isConnected) {\n        button.classList.remove('sa-comment-vscode-disabled');\n        button.title = commentEl.dataset.vscodeSynced ? msg('synced-tooltip') : msg('sync-tooltip');\n      } else {\n        button.classList.add('sa-comment-vscode-disabled');\n        button.title = msg('not-connected');\n      }\n    }\n  }\n  \n  // 监听来自 extension-debug.js 的自定义事件\n  window.addEventListener('commentSyncUpdate', handleCommentUpdate);\n  \n  // 监听连接状态变化\n  window.addEventListener('extensionDebugStatus', (e) => {\n    if (e.detail) {\n      isConnected = e.detail.connected;\n      updateButtonStates();\n    }\n  });\n  \n  // 监听 DOM 变化\n  const observer = new MutationObserver((mutations) => {\n    let shouldProcess = false;\n    \n    mutations.forEach(mutation => {\n      mutation.addedNodes.forEach(node => {\n        if (node.nodeType === Node.ELEMENT_NODE) {\n          if (node.matches && node.matches('.blocklyBubbleCanvas > g')) {\n            shouldProcess = true;\n          } else if (node.querySelector && node.querySelector('.blocklyBubbleCanvas > g')) {\n            shouldProcess = true;\n          }\n        }\n      });\n    });\n    \n    if (shouldProcess) {\n      setTimeout(processCommentElements, 100);\n    }\n    \n    // 定期清理\n    cleanupRemovedComments();\n  });\n  \n  // 开始监听\n  observer.observe(document.body, {\n    childList: true,\n    subtree: true\n  });\n  \n  // 初始处理\n  setTimeout(processCommentElements, 1000);\n  \n  // 定期处理新元素和更新状态\n  setInterval(() => {\n    processCommentElements();\n    updateButtonStates();\n  }, 2000);\n  \n  // 插件禁用时清理\n  addon.self.addEventListener('disabled', () => {\n    observer.disconnect();\n    for (const [commentEl, data] of processedComments) {\n      if (data.button) {\n        data.button.remove();\n      }\n    }\n    processedComments.clear();\n    window.removeEventListener('commentSyncUpdate', handleCommentUpdate);\n    console.log('[CommentVSCodeSync] Addon disabled');\n  });\n  \n  // 插件启用时重新处理\n  addon.self.addEventListener('enabled', () => {\n    observer.observe(document.body, {\n      childList: true,\n      subtree: true\n    });\n    setTimeout(processCommentElements, 500);\n    console.log('[CommentVSCodeSync] Addon enabled');\n  });\n  \n  console.log('[CommentVSCodeSync] Addon loaded');\n}\n"],"mappings":";;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACPA;AAAA;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;;;A","sourceRoot":""}