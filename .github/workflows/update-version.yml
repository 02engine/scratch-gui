name: Update versions.json

on:
  schedule:
    - cron: '0 0 * * *'          # æ¯å¤© UTC 00:00ï¼ˆåŒ—äº¬/é¦™æ¸¯æ—¶é—´æ—©ä¸Š 8:00ï¼‰
  workflow_dispatch:             # æ”¯æŒæ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  update-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write            # å¿…é¡»ï¼Œç”¨äºæ¨é€å†…å®¹

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      # è·å–ä»“åº“ä¸­ç‰ˆæœ¬å·æœ€å¤§çš„ tagï¼ˆä½œä¸º latestï¼‰
      - name: è·å– latest tag
        id: latest
        uses: oprypin/find-latest-tag@v1
        with:
          repository: 02engine/desktop
          releases-only: false
          regex: '^v\d+\.\d+\.\d+-[0-9a-f]+$'   # ç²¾ç¡®åŒ¹é… vX.Y.Z-hash æ ¼å¼
          sort-tags: true                       # æŒ‰ç‰ˆæœ¬é™åºæ’åºï¼Œå–æœ€å¤§

      # ç”Ÿæˆ versions.jsonï¼ˆlatest_unstable æ°¸ä¹…ä¸ºç©ºï¼Œoldest_safe å›ºå®šå€¼ï¼‰
      - name: ç”Ÿæˆ versions.json
        run: |

          mkdir -p ver

          # latest æ¥è‡ª action è¾“å‡º
          LATEST="${{ steps.latest.outputs.tag }}"

          # latest_unstable æ°¸è¿œä¸ºç©º
          UNSTABLE=""

          # oldest_safe å›ºå®šå†™æ­»ä¸ºä½ æŒ‡å®šçš„å€¼
          OLDEST_SAFE="v1.1.0-239378be"

          jq -n \
            --arg latest "$LATEST" \
            --arg unstable "$UNSTABLE" \
            --arg oldest "$OLDEST_SAFE" \
            '{
              latest: $latest,
              latest_unstable: ($unstable | if . == "" then null else . end),
              oldest_safe: $oldest
            }' > ./ver/versions.json

          echo "ç”Ÿæˆçš„ JSON å†…å®¹ï¼š"
          cat ./ver/versions.json

      # éƒ¨ç½²å•ä¸ªæ–‡ä»¶åˆ° cf-page åˆ†æ”¯
      - name: éƒ¨ç½²åˆ° cf-page åˆ†æ”¯ ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: cf-page                   # ä½ å¯ä»¥æ”¹å› cf-page
          folder: ./ver                               # versions.json åœ¨æ ¹ç›®å½•
          target-folder: .                        # æ”¾æ ¹ç›®å½•ï¼ˆå¯æ”¹æˆ data/ ç­‰ï¼‰
          clean: false                             # æ¸…ç©ºæ—§æ–‡ä»¶ï¼Œåªä¿ç•™æœ€æ–° JSON
          commit-message: "chore: æ¯æ—¥æ›´æ–° versions.json (${{ github.run_id }})"
