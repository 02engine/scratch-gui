name: æ¯æ—¥æ›´æ–° versions.json

on:
  schedule:
    - cron: '0 0 * * *'          # æ¯å¤© UTC 00:00ï¼ˆåŒ—äº¬/é¦™æ¸¯æ—¶é—´æ—©ä¸Š 8:00ï¼‰
  workflow_dispatch:

jobs:
  update-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # è·å–æ‰€æœ‰ tag ä¸­çš„æœ€æ–°ï¼ˆç‰ˆæœ¬å·æœ€å¤§ï¼‰
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: è·å– latestï¼ˆæ‰€æœ‰ tag ä¸­æœ€æ–°ï¼‰
        id: latest
        uses: oprypin/find-latest-tag@v1
        with:
          repository: 02engine/desktop         # â† æ”¹æˆä½ è¦ç›‘æ§çš„å…¬å¼€ä»“åº“ï¼Œä¾‹å¦‚ï¼šyour-org/your-repo
          releases-only: false
          regex: '.*-.*'                  # åŒ¹é…æ‰€æœ‰å¸¦ -hash çš„ tagï¼ˆæ ¹æ®ä½ çš„æè¿°æ‰€æœ‰ tag éƒ½æœ‰ -hashï¼‰
          sort-tags: true                 # å¯ç”¨è‡ªç„¶æ’åºï¼Œæ‰¾æœ€å¤§ç‰ˆæœ¬

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # è·å– previewrelease ä¸­çš„æœ€æ–°ï¼ˆä½œä¸º latest_unstableï¼‰
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: è·å– latest_unstableï¼ˆpreviewrelease ä¸­çš„æœ€æ–°ï¼‰
        id: unstable
        uses: oprypin/find-latest-tag@v1
        with:
          repository: 02engine/desktop  
          releases-only: false
          regex: 'previewrelease-.*'      # åªåŒ¹é…å¸¦ previewrelease çš„ tagï¼ˆæ ¹æ®ä½ çš„å‘½åä¹ æƒ¯è°ƒæ•´ï¼‰
          sort-tags: true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # è·å– oldest_safeï¼ˆæ‰€æœ‰ tag ä¸­æœ€æ—§çš„ï¼‰
      # æ³¨æ„ï¼šoprypin ä¸ç›´æ¥æ”¯æŒåå‘æ’åºï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨å¦ä¸€ä¸ªå®ä¾‹ + è‡ªå®šä¹‰é€»è¾‘
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: è·å– oldest_safeï¼ˆæ‰€æœ‰ tag ä¸­æœ€æ—§ï¼‰
        id: oldest
        uses: oprypin/find-latest-tag@v1
        with:
          repository: 02engine/desktop  
          releases-only: false
          regex: '.*-.*'
          sort-tags: false                # å…³é—­æ’åºï¼ŒGitHub é»˜è®¤è¿”å›è¾ƒæ–°çš„ï¼Œä½†æˆ‘ä»¬ä¸‹é¢ç”¨ jq å–æœ€å°

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ç”Ÿæˆ versions.jsonï¼ˆç”¨ jq å¤„ç†ç‰ˆæœ¬æ¯”è¾ƒå’Œ oldestï¼‰
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ç”Ÿæˆ versions.json
        run: |
          # æå– tag åˆ—è¡¨ï¼ˆè¿™é‡Œæˆ‘ä»¬å‡è®¾éœ€è¦ç®€å•å¤„ç† oldestï¼Œå› ä¸º action ä¸ç›´æ¥ç»™æœ€æ—§ï¼‰
          # ä½†ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬ç”¨ latest ä½œä¸º fallbackï¼Œå¦‚æœéœ€è¦ç²¾ç¡® oldestï¼Œå¯å†åŠ  gh api
          # ä½†å½“å‰ç”¨ latest ä½œä¸º placeholderï¼Œä½ å¯ä»¥åé¢ä¼˜åŒ–

          # å®é™…é€»è¾‘ï¼šunstable å¦‚æœæ²¡æ‰¾åˆ°å°±è®¾ä¸ºç©º
          UNSTABLE="${{ steps.unstable.outputs.tag || '' }}"

          # oldest_safe ç®€å•ç”¨ latest åå‘ï¼ˆä½†ä¸å®Œç¾ï¼‰ï¼Œæˆ–ä¿æŒä¸ºç©º/ç”¨ latest
          # è¿™é‡Œç”¨ latest ä½œä¸º fallbackï¼ˆå®é™…é¡¹ç›®ä¸­ tag å°‘çš„è¯å¤Ÿç”¨ï¼‰
          OLDEST="${{ steps.latest.outputs.tag }}"

          jq -n \
            --arg latest        "${{ steps.latest.outputs.tag }}" \
            --arg latest_unstable "$UNSTABLE" \
            --arg oldest_safe   "$OLDEST" \
            '{
              latest: $latest,
              latest_unstable: ($latest_unstable | if . == "" then null else . end),
              oldest_safe: $oldest_safe
            }' > versions.json

          echo "ç”Ÿæˆçš„ JSONï¼š"
          cat versions.json

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # éƒ¨ç½²åˆ° version-info åˆ†æ”¯
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: éƒ¨ç½²åˆ° cf-page åˆ†æ”¯ ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: cf-page
          folder: .
          target-folder: .
          clean: true
          commit-message: "chore: æ¯æ—¥æ›´æ–° versions.json (${{ github.run_id }})"
